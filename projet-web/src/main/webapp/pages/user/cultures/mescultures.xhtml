<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition template="/template/page-standard.xhtml"
     xmlns="http://www.w3.org/1999/xhtml"
     xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:ui="http://java.sun.com/jsf/facelets">

    <f:metadata>
        <f:viewParam name="idParcelle" value="#{modelContenir.idParcelleSelectionnee}" />
        <f:viewAction action="#{modelContenir.chargerParParcelle()}" />
    </f:metadata>

    <ui:define name="titre">Mes Cultures</ui:define>

    <ui:define name="contenu">

        <h2>Gestion de mes cultures</h2>

        <h:panelGroup>
            <h3>Parcelle #{modelContenir.idParcelleSelectionnee}</h3>
            <p>
                Occupation : 
                <h:outputText value="#{modelContenir.getSommePartsParcelle(modelContenir.idParcelleSelectionnee)}">
                    <f:convertNumber maxFractionDigits="2" />
                </h:outputText> %
                | Restant : 
                <strong>
                    <h:outputText value="#{modelContenir.getPartRestante(modelContenir.idParcelleSelectionnee)}">
                        <f:convertNumber maxFractionDigits="2" />
                    </h:outputText> %
                </strong>
            </p>
        </h:panelGroup>

        <h:form>

            <h3>Mes cultures actuelles</h3>

            <h:panelGroup rendered="#{empty modelContenir.getCulturesDeParcelle(modelContenir.idParcelleSelectionnee)}">
                <p>Vous n'avez pas encore planté de culture sur cette parcelle.</p>
            </h:panelGroup>

            <h:dataTable value="#{modelContenir.getCulturesDeParcelle(modelContenir.idParcelleSelectionnee)}"
                         var="cult"
                         rendered="#{not empty modelContenir.getCulturesDeParcelle(modelContenir.idParcelleSelectionnee)}"
                         styleClass="liste"
                         rowClasses="impair, pair"
                         columnClasses="left,center,center">

                <h:column>
                    <f:facet name="header">
                        <h:outputText value="Culture" />
                    </f:facet>
                    #{cult.nom}
                </h:column>

                <h:column>
                    <f:facet name="header">
                        <h:outputText value="Part (%)" />
                    </f:facet>
                    <h:outputText value="#{modelContenir.getPartCulture(modelContenir.idParcelleSelectionnee, cult.id)}">
                        <f:convertNumber maxFractionDigits="2" />
                    </h:outputText>
                </h:column>

                <h:column>
                    <f:facet name="header">
                        <h:outputText value="Action" />
                    </f:facet>
                    <h:commandButton value="Retirer"
                                     action="#{modelContenir.retirerCulture(modelContenir.idParcelleSelectionnee, cult.id)}"
                                     onclick="return confirm('Retirer cette culture ?')"
                                     styleClass="btn btn-secondary">
                        <f:ajax execute="@this" render="@form" />
                    </h:commandButton>
                </h:column>

            </h:dataTable>

            <br />

            <h:panelGroup rendered="#{modelContenir.getPartRestante(modelContenir.idParcelleSelectionnee) > 0}">
                <h3>Ajouter une culture</h3>

                <table class="form">
                    <tr>
                        <td>
                            <h:outputLabel for="culture">Culture :</h:outputLabel>
                        </td>
                        <td>
                            <h:selectOneMenu id="culture" value="#{modelContenir.idCultureAAjouter}" required="true">
                                <f:selectItem itemValue="#{null}" itemLabel="-- Choisir --"/>
                                <f:selectItems value="#{modelCulture.liste}" 
                                               var="c"
                                               itemValue="#{c.id}" 
                                               itemLabel="#{c.nom}"/>
                            </h:selectOneMenu>
                            <br /><h:message for="culture" errorClass="error"/>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <h:outputLabel for="part">Part (%) :</h:outputLabel>
                        </td>
                        <td>
                            <h:inputText id="part" value="#{modelContenir.partAAjouter}" 
                                         required="true" size="10">
                                <f:convertNumber maxFractionDigits="2" />
                            </h:inputText>
                            <br /><h:message for="part" errorClass="error"/>
                        </td>
                    </tr>
                </table>

                <h:commandButton value="Ajouter"
                                 action="#{modelContenir.ajouterCulturePourParcelle()}"
                                 styleClass="btn btn-primary">
                    <f:ajax execute="@form" render="@form" />
                </h:commandButton>
            </h:panelGroup>

            <h:panelGroup rendered="#{modelContenir.getPartRestante(modelContenir.idParcelleSelectionnee) <= 0}">
                <p style="color: orange; font-weight: bold;">
                    Votre parcelle est pleine (100% occupée).
                </p>
            </h:panelGroup>

            <br />
            <h:button value="Retour à mes parcelles" 
                      outcome="liste" 
                      styleClass="btn btn-secondary" />

        </h:form>

    </ui:define>

</ui:composition>